<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Classifier Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Flower Classifier Test</h1>
            <p class="text-gray-600 mb-6">Use your camera to test the flower classifier in real-time</p>

            <!-- Status Indicator -->
            <div id="status" class="mb-6 p-4 rounded-lg bg-gray-50 border border-gray-200">
                <div class="flex items-center gap-2">
                    <div id="status-indicator" class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <span id="status-text" class="text-sm font-medium text-gray-700">Checking classifier status...</span>
                </div>
            </div>

            <!-- Camera Feed -->
            <div class="mb-6">
                <div class="flex gap-4 mb-4">
                    <button id="startCameraBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        Start Camera
                    </button>
                    <button id="stopCameraBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors hidden">
                        Stop Camera
                    </button>
                    <button id="captureBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors hidden">
                        Capture & Classify
                    </button>
                    <button id="autoCaptureBtn" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors hidden">
                        <span id="autoCaptureText">Start Auto-Capture</span>
                    </button>
                </div>
                
                <div id="cameraContainer" class="hidden">
                    <div class="relative rounded-lg overflow-hidden border-2 border-gray-300 bg-black">
                        <video id="video" autoplay playsinline class="w-full h-auto max-h-96 object-cover"></video>
                        <div class="absolute top-2 left-2 bg-red-600/80 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">
                            <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                            LIVE
                        </div>
                        <canvas id="canvas" class="hidden"></canvas>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Camera feed active. Click "Capture & Classify" to test, or enable auto-capture for continuous classification.</p>
                </div>
                
                <div id="noCamera" class="hidden p-8 border-2 border-dashed border-gray-300 rounded-lg text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M15 10l-3-3m0 0l-3 3m3-3v18m-3 0h6m12 0h6m-9-18l3-3m0 0l3 3m-3-3v18m3 0h-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="text-gray-600 font-medium">Camera not available</p>
                    <p class="text-sm text-gray-500 mt-2">Please allow camera access when prompted</p>
                </div>
            </div>

            <!-- Results -->
            <div id="results" class="hidden">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Classification Result</h2>
                <div id="resultContent" class="p-6 rounded-lg border-2"></div>
            </div>

            <!-- Error Display -->
            <div id="error" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-800 font-medium">Error:</p>
                <p id="errorMessage" class="text-red-600 text-sm mt-1"></p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api';
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const autoCaptureBtn = document.getElementById('autoCaptureBtn');
        const autoCaptureText = document.getElementById('autoCaptureText');
        const cameraContainer = document.getElementById('cameraContainer');
        const noCamera = document.getElementById('noCamera');
        const results = document.getElementById('results');
        const resultContent = document.getElementById('resultContent');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        
        let stream = null;
        let autoCaptureInterval = null;
        let isAutoCapturing = false;

        // Check classifier status on load
        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/camera/status`);
                const data = await response.json();
                
                if (data.classifierAvailable) {
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    statusText.textContent = 'Classifier is available and ready';
                } else {
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
                    statusText.textContent = 'Classifier not available - Model may not be trained yet';
                }
            } catch (err) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = 'Error checking status: ' + err.message;
            }
        }

        // Start camera
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Prefer back camera (for phone)
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                cameraContainer.classList.remove('hidden');
                noCamera.classList.add('hidden');
                startCameraBtn.classList.add('hidden');
                stopCameraBtn.classList.remove('hidden');
                captureBtn.classList.remove('hidden');
                autoCaptureBtn.classList.remove('hidden');
                
                statusText.textContent = 'Camera active';
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
            } catch (err) {
                console.error('Error accessing camera:', err);
                showError('Unable to access camera. Please check permissions and ensure you are using HTTPS or localhost.');
                noCamera.classList.remove('hidden');
                cameraContainer.classList.add('hidden');
            }
        });

        // Stop camera
        stopCameraBtn.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            cameraContainer.classList.add('hidden');
            startCameraBtn.classList.remove('hidden');
            stopCameraBtn.classList.add('hidden');
            captureBtn.classList.add('hidden');
            autoCaptureBtn.classList.add('hidden');
            
            if (autoCaptureInterval) {
                clearInterval(autoCaptureInterval);
                autoCaptureInterval = null;
                isAutoCapturing = false;
                autoCaptureText.textContent = 'Start Auto-Capture';
            }
            
            statusText.textContent = 'Camera stopped';
        });

        // Capture and classify
        captureBtn.addEventListener('click', async () => {
            if (!stream || video.readyState !== video.HAVE_ENOUGH_DATA) {
                showError('Camera not ready. Please wait a moment and try again.');
                return;
            }
            
            await captureAndClassify();
        });

        // Auto-capture toggle
        autoCaptureBtn.addEventListener('click', () => {
            if (!isAutoCapturing) {
                // Start auto-capture
                isAutoCapturing = true;
                autoCaptureText.textContent = 'Stop Auto-Capture';
                autoCaptureInterval = setInterval(async () => {
                    if (stream && video.readyState === video.HAVE_ENOUGH_DATA) {
                        await captureAndClassify();
                    }
                }, 2000); // Capture every 2 seconds
            } else {
                // Stop auto-capture
                isAutoCapturing = false;
                autoCaptureText.textContent = 'Start Auto-Capture';
                if (autoCaptureInterval) {
                    clearInterval(autoCaptureInterval);
                    autoCaptureInterval = null;
                }
            }
        });

        // Capture frame and classify
        async function captureAndClassify() {
            try {
                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0);
                
                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        showError('Failed to capture frame');
                        return;
                    }
                    
                    // Hide previous results
                    error.classList.add('hidden');
                    
                    // Classify image
                    await classifyImage(blob);
                }, 'image/jpeg', 0.8);
            } catch (err) {
                showError('Error capturing frame: ' + err.message);
            }
        }

        // Classify image
        async function classifyImage(blob) {
            try {
                statusText.textContent = 'Classifying image...';
                statusIndicator.className = 'w-3 h-3 rounded-full bg-blue-500 animate-pulse';

                const formData = new FormData();
                formData.append('image', blob, 'frame.jpg');
                formData.append('width', video.videoWidth || 0);
                formData.append('height', video.videoHeight || 0);

                const response = await fetch(`${API_BASE_URL}/camera/frame`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    displayResults(data);
                    if (!isAutoCapturing) {
                        statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                        statusText.textContent = 'Classification complete';
                    } else {
                        statusIndicator.className = 'w-3 h-3 rounded-full bg-blue-500 animate-pulse';
                        statusText.textContent = 'Auto-capturing...';
                    }
                } else {
                    throw new Error(data.message || 'Classification failed');
                }
            } catch (err) {
                showError(err.message);
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = 'Classification failed';
            }
        }

        // Display results
        function displayResults(data) {
            results.classList.remove('hidden');
            error.classList.add('hidden');

            if (data.classification) {
                const classification = data.classification;
                const isFlower = classification.isFlower;
                const confidence = (classification.confidence * 100).toFixed(1);
                const className = classification.class;

                resultContent.innerHTML = `
                    <div class="flex items-center gap-4 mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Result</h3>
                            <div class="flex items-center gap-3">
                                <span class="text-3xl font-bold ${isFlower ? 'text-green-600' : 'text-gray-600'}">
                                    ${isFlower ? 'üå∏' : '‚ùå'}
                                </span>
                                <div>
                                    <p class="text-xl font-bold ${isFlower ? 'text-green-600' : 'text-gray-600'}">
                                        ${className}
                                    </p>
                                    <p class="text-sm text-gray-500">Confidence: ${confidence}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Details</h4>
                        <div class="space-y-1 text-sm text-gray-600">
                            <p><strong>Class:</strong> ${className}</p>
                            <p><strong>Is Flower:</strong> ${isFlower ? 'Yes' : 'No'}</p>
                            <p><strong>Confidence:</strong> ${confidence}%</p>
                            <p><strong>Raw Score:</strong> ${classification.score.toFixed(4)}</p>
                        </div>
                    </div>
                `;

                if (isFlower) {
                    resultContent.className = 'p-6 rounded-lg border-2 border-green-500 bg-green-50';
                } else {
                    resultContent.className = 'p-6 rounded-lg border-2 border-gray-300 bg-gray-50';
                }
            } else if (data.classificationError) {
                resultContent.innerHTML = `
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-800 font-medium">Classification Not Available</p>
                        <p class="text-yellow-600 text-sm mt-1">${data.classificationError}</p>
                        <p class="text-yellow-600 text-xs mt-2">The image was received, but classification could not be performed. Make sure the model is trained and available.</p>
                    </div>
                `;
                resultContent.className = 'p-6 rounded-lg border-2 border-yellow-300';
            } else {
                resultContent.innerHTML = `
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <p class="text-gray-800">Image received successfully, but no classification data available.</p>
                    </div>
                `;
                resultContent.className = 'p-6 rounded-lg border-2 border-gray-300';
            }
        }

        // Show error
        function showError(message) {
            error.classList.remove('hidden');
            errorMessage.textContent = message;
            results.classList.add('hidden');
        }

        // Initialize
        checkStatus();
    </script>
</body>
</html>

